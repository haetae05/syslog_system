{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Left: Mixed Chart (Bar + Line) -->
    <div class="col-lg-8">
        <div class="card p-4 h-100">
            <h3 class="mb-4">üìä ÏõîÎ≥Ñ Ïû•Ïï† Î∞úÏÉù Ï∂îÏù¥</h3>
            <div id="loading" class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <canvas id="mixedChart"></canvas>
        </div>
    </div>

    <!-- Right: Pie Chart (Top 5 Distribution) -->
    <div class="col-lg-4">
        <div class="card p-4 h-100">
            <h3 class="mb-4">üç© Ïû•Ïï† Ïú†Ìòï Î∂ÑÌè¨ (Top 5)</h3>
            <canvas id="pieChart"></canvas>
            <div id="pieLegend" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const loading = document.getElementById('loading');

        fetch('/api/analyze')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';

                // 1. Mixed Chart (Bar: Count, Line: Ratio)
                const ctxMixed = document.getElementById('mixedChart').getContext('2d');
                new Chart(ctxMixed, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'ÏõîÎ≥Ñ Ïû•Ïï† Í±¥Ïàò',
                                data: data.monthly_totals,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1,
                                yAxisID: 'y',
                            },
                            {
                                label: 'ÎπÑÏú® (%)',
                                data: data.monthly_ratios,
                                type: 'line',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#ffffff' },
                                title: { display: true, text: 'Ïû•Ïï† Í±¥Ïàò', color: '#ffffff' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { 
                                    color: '#ff9f40',
                                    callback: function(value) {
                                        return value.toFixed(4) + '%';
                                    }
                                },
                                title: { display: true, text: 'Ïû•Ïï† ÎπÑÏú® (%)', color: '#ff9f40' }
                            },
                            x: {
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#ffffff', font: { size: 14 } } },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        }
                    }
                });

                // 2. Pie Chart (Top 5 Types)
                const ctxPie = document.getElementById('pieChart').getContext('2d');
                new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: data.top_5,
                        datasets: [{
                            data: data.top_5_counts, // Needs to be calculated in app.py
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#ffffff', font: { size: 12 }, padding: 20 }
                            }
                        }
                    }
                });
            });
    });
</script>
{% endblock %}