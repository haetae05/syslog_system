{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-11">
        <div class="card p-4">
            <h2 class="mb-4">ğŸ”® ì‹¤ì‹œê°„ ì¥ì•  ì˜ˆì¸¡ (Real-time Timeline)</h2>
            <p class="text-secondary mb-4">
                í˜„ì¬ í•™ìŠµëœ <b>5~11ì›” ë°ì´í„° íŒ¨í„´</b>ì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
                ì‹œê°„ì€ ì •ê¸° ì£¼ê¸°ì— ë”°ë¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³„ì‚°ë˜ë©°, ê° ì´ë²¤íŠ¸ëŠ” ê³ ì •ëœ ì£¼ê¸°ì— ë”°ë¼ ì¼ê´€ë˜ê²Œ ë°œìƒì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤.
            </p>

            <div class="d-flex gap-2">
                <button id="forecastBtn" class="btn btn-success btn-lg mb-4">
                    <span class="spinner-border spinner-border-sm d-none" id="btnSpinner"></span>
                    Run Analysis
                </button>
                <div id="liveStatus" class="mt-2 text-info d-none">â— Live Counting...</div>
            </div>

            <div id="resultArea" class="d-none">
                <div class="table-responsive">
                    <table class="table table-dark table-hover table-bordered table-sm">
                        <thead>
                            <tr class="table-active">
                                <th>ì˜ˆì • ì‹œê°„ (Time)</th>
                                <th>ì¥ì•  ìœ í˜• (Error Type)</th>
                                <th>ìˆœë²ˆ (Seq)</th>
                                <th>24h í™•ë¥  (Prob.)</th>
                                <th>ìœ„í—˜ë„ (Risk)</th>
                                <th style="width: 151px;">ë‚¨ì€ ì‹œê°„ (Countdown)</th>
                                <th>í‰ê·  ì£¼ê¸° (MTBF)</th>
                            </tr>
                        </thead>
                        <tbody id="forecastTableBody">
                            <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-warning mt-3">
                    <small>* ì‹¤ì‹œê°„ ê³„ì‚°: "ë‚¨ì€ ì‹œê°„"ì€ í˜„ì¬ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ë§¤ì´ˆ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. ì‹œê°„ì´ ì§€ë‚˜ë©´ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let countdownInterval = null;
    let forecastData = [];

    document.getElementById('forecastBtn').addEventListener('click', function () {
        const btn = this;
        const spinner = document.getElementById('btnSpinner');
        const resultArea = document.getElementById('resultArea');
        const liveStatus = document.getElementById('liveStatus');

        btn.disabled = true;
        spinner.classList.remove('d-none');

        fetch('/api/forecast')
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                spinner.classList.add('d-none');

                if (data.status === 'success') {
                    forecastData = data.data;
                    resultArea.classList.remove('d-none');
                    liveStatus.classList.remove('d-none');
                    renderTable();
                    startCountdown();
                }
            })
            .catch(err => {
                btn.disabled = false;
                spinner.classList.add('d-none');
                alert("Error: " + err);
            });
    });

    function renderTable() {
        const tableBody = document.getElementById('forecastTableBody');
        tableBody.innerHTML = "";

        forecastData.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            tr.innerHTML = `
                <td><b>${item.next_est}</b></td>
                <td><span class="badge bg-secondary">${item.type}</span></td>
                <td><small class="text-secondary">#${item.occurrence_index}</small></td>
                <td class="text-info">${item.prob_24h}</td>
                <td class="${item.risk_color}">${item.risk}</td>
                <td id="countdown-${index}" class="bg-dark text-center fw-bold text-warning font-monospace">--:--:--</td>
                <td><small class="text-secondary">${item.mtbf}</small></td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function startCountdown() {
        if (countdownInterval) clearInterval(countdownInterval);

        countdownInterval = setInterval(() => {
            const now = new Date().getTime();
            let anyRemoved = false;

            forecastData.forEach((item, index) => {
                const target = new Date(item.timestamp_iso).getTime();
                const distance = target - now;
                const element = document.getElementById(`countdown-${index}`);

                if (distance < 0) {
                    if (element) {
                        element.innerText = "EXPIRED";
                        element.classList.remove('text-warning');
                        element.classList.add('text-danger');
                    }
                    // Optionally remove or mark as occurred
                } else {
                    const h = Math.floor(distance / (1000 * 60 * 60));
                    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((distance % (1000 * 60)) / 1000);

                    if (element) {
                        element.innerText =
                            String(h).padStart(2, '0') + "h " +
                            String(m).padStart(2, '0') + "m " +
                            String(s).padStart(2, '0') + "s";
                    }
                }
            });
        }, 1000);
    }
</script>
{% endblock %}